<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Bilibili</title>
    <script src="ind_cpp.js"></script>
    <script src="components.js"></script>
    <!-- 加载组件定义 -->
    <link
      rel="stylesheet"
      href="https://hmos.dongs.xyz/harmonyos_sans_sc.css"
    />
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }

      body {
        font-family: "HarmonyOS Sans SC", sans-serif;
        overflow-x: hidden;
      }

      .component {
        position: absolute;
        /* border: 1px solid black; */
        /* background-color: black; */
      }

      .carousel {
        position: absolute;
        max-width: 100%;
        overflow: hidden;
      }

      .carousel-inner {
        display: flex;
        width: 100%;
        height: 100%;
        transition: transform 0.5s ease-in-out;
        /* touch-action: pan-y; */
      }

      .carousel-item {
        min-width: 100%;
        box-sizing: border-box;
      }

      .carousel-inner img {
        /* border: 1px solid red; */
      }

      .carousel-button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 10px;
        cursor: pointer;
        z-index: 10;
      }

      .carousel-button.prev {
        left: 10px;
      }

      .carousel-button.next {
        right: 10px;
      }

      body > .content {
        overflow: hidden;
        line-height: 1.3;
        max-height: calc(1.3em * 2);
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        background-color: white;
        border-radius: 10px;
      }

      body > .main-body-holder {
        background-color: whitesmoke;
        /* color: red; */
        z-index: -1;
      }

      .fixedElement {
        position: fixed;
        /* border: 1px solid black; */
        background-color: white;
        font-size: small;
      }

      .text {
        white-space: nowrap;
        display: flex;
        justify-content: center;
        align-items: center;
        color: grey;
      }

      .current-upper-tab {
        color: rgb(255, 121, 144);
        border-bottom: 3px solid rgb(255, 121, 144);
        font-size: 20px;
      }

      .current-under-tab {
        color: rgb(255, 121, 144);
      }

      .search-text {
        white-space: nowrap;
        overflow: hidden;
        font-size: 16px;
        display: flex;
        align-items: center;
        color: grey;
      }

      .search-bar {
        opacity: 15%;
        position: absolute;
        border: 2px solid rgb(64, 64, 64);
        border-radius: 20px;
      }

      img {
        width: 100%;
        height: 100%;
      }

      .footer {
        display: flex;
        position: fixed;
        bottom: 0;
        width: fit-content;
        height: 70px;
        text-align: center;
        line-height: 70px;
      }

      ::-webkit-scrollbar {
        display: none;
      }

      .mask {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1001;
      }
      .hidden {
        display: none;
      }

      .controls {
        left: 10%;
        position: fixed;
        bottom: 20px;
        width: 80%;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 1001;
      }

      .radius-display {
        margin-top: 10px;
        font-size: 18px;
        color: lightblue;
      }

      input[type="range"] {
        width: 100%;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <svg id="mask" class="mask hidden" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <mask id="mask-rect">
          <rect width="100%" height="100%" fill="white" />
          <rect id="transparentRect" x="0" y="0" rx="0" ry="0" fill="black" />
        </mask>
      </defs>
      <rect width="100%" height="100%" fill="black" mask="url(#mask-rect)" />
    </svg>

    <div class="controls">
      <input id="radiusRange" type="range" min="0" max="0" value="0" />
      <div id="radiusDisplay" class="radius-display"></div>
    </div>
    <script>
      let moduleInstance = null;
      const elementCache = []; // 使用数组来缓存组件元素
      let currentIdx = 0;
      let totalSlides = 0;
      let autoSlideInterval;
      let debounceTimeout;
      const radiusRange = document.getElementById("radiusRange");
      const radiusDisplay = document.getElementById("radiusDisplay");
      const controls = document.querySelector(".controls");
      const transparentRect = document.getElementById("transparentRect");

      /**
       * mask 相关
       */
      function checkVisibility() {
        const targetDiv = document.getElementById("watch_car_0");
        if (targetDiv && getComputedStyle(targetDiv).visibility === "visible") {
          showMask();
          showControls();
          enableScrollByDiameter();
        } else {
          hideMask();
          hideControls();
          disableScrollByDiameter();
        }
      }

      function showMask() {
        const mask = document.getElementById("mask");
        mask.classList.remove("hidden");
        setMaxRadius();
        updateMask(radiusRange.value);
      }

      function hideMask() {
        const mask = document.getElementById("mask");
        mask.classList.add("hidden");
      }

      function updateMask(borderRadius) {
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        const tab = document.getElementById("title_holder");
        const tabPlus = document.getElementById("main_body_watch_kid_0");

        let tabHeight = 0;
        if (tab && tabPlus) {
          tabHeight =
            parseInt(getComputedStyle(tab).height) +
            parseInt(getComputedStyle(tabPlus).height);
        }

        // 更新圆角矩形的位置和大小
        transparentRect.setAttribute("width", windowWidth);
        transparentRect.setAttribute("height", windowWidth); // 这里宽度和高度设置成相同，形成正方形
        transparentRect.setAttribute("x", 0);
        transparentRect.setAttribute("y", tabHeight);

        // 更新圆角半径
        transparentRect.setAttribute("rx", borderRadius);
        transparentRect.setAttribute("ry", borderRadius);

        // 更新显示的圆角值
        radiusDisplay.textContent = `Current Radius: ${borderRadius}px\n Window Width: ${windowWidth}px`;
      }

      /**
       * 圆角控制器相关
       */
      function showControls() {
        controls.style.display = "block";
      }

      function hideControls() {
        controls.style.display = "none";
      }

      function setMaxRadius() {
        const maxRadius = window.innerWidth / 2;
        radiusRange.max = maxRadius;
      }

      /**
       * 轮播图相关
       */
      function initializeCarousel() {
        // 创建 carousel 容器
        const carousel = document.createElement("div");
        carousel.className = "carousel";
        carousel.id = "main_body_pic";

        // 创建 carousel-inner 容器
        const carouselInner = document.createElement("div");
        carouselInner.className = "carousel-inner";
        // carouselInner.id = "main_body_pic";
        carousel.appendChild(carouselInner);

        const prevButton = document.createElement("button");
        prevButton.className = "carousel-button prev";
        prevButton.innerHTML = "&#10094";
        prevButton.onclick = prevSlide;

        const nextButton = document.createElement("button");
        nextButton.className = "carousel-button next";
        nextButton.innerHTML = "&#10095";
        nextButton.onclick = nextSlide;

        carousel.appendChild(prevButton);
        carousel.appendChild(nextButton);

        document.body.appendChild(carousel);
      }

      function renderCarousel(name, images) {
        const carouselInner = document.querySelector(".carousel-inner");
        for (const key in images) {
          let div = document.createElement("div");
          div.id = name;
          div.className = "carousel-item";
          const img = new Image();
          img.src = images[key];
          div.appendChild(img);
          carouselInner.appendChild(div);
        }

        totalSlides = document.querySelectorAll(".carousel-item").length;
      }

      /**
       * 组建元素相关
       */
      function initializeComponents(screenWidth) {
        if (!moduleInstance) {
          createModule().then((Module) => {
            moduleInstance = Module;
            const componentNames = moduleInstance.getInitialComponents();
            renderComponents(componentNames);
          });
        } else {
          const componentNames = moduleInstance.getInitialComponents();
          renderComponents(componentNames);
        }
      }

      function renderComponents(componentNames) {
        // 清空现有组件
        elementCache.length = 0; // 清空缓存数组
        const carouselInner = document.createElement("div");

        initializeCarousel();

        // 创建mask
        let mask = document.createElement("div");
        mask.id = "mask";
        mask.className = "mask hidden";
        document.body.appendChild(mask);

        for (const key in imageurls) {
          if (key.includes("main")) {
            renderCarousel(key, imageurls[key]);
          } else {
            let div = document.createElement("div");
            div.id = key;
            div.className = "component";
            const imageurl = imageurls[key];
            const img = new Image();
            img.src = imageurl;
            div.appendChild(img);
            document.body.appendChild(div);
          }
        }

        for (const key in texts) {
          let div = document.createElement("div");
          div.id = key;
          if (key === "search_bar_kid_1" || key == "search_bar_tv_kid_1") {
            div.className = "component search-text";
          } else if (key.includes("kid_1")) {
            div.className = "component text current-upper-tab";
          } else {
            div.className = "component text";
          }
          if (key.includes("body")) {
            div.className = "component content";
          }

          const text = texts[key];
          // div.style.border = "1px solid";
          div.textContent = text[0];
          div.style.fontSize = text[1];
          document.body.appendChild(div);
        }
        for (const key in abs_pos) {
          let div = document.createElement("div");
          div.id = key;
          div.className = "fixedElement";
          const info = abs_pos[key];
          if (info.length > 0) {
            if (info[0]) {
              const img = new Image();
              img.src = info[0];
              div.appendChild(img);
            }
            if (info[1]) {
              div.className = "fixedElement text";
              if (key == "home_name" || key == "home_name2") {
                div.classList.add("current-under-tab");
              }
              div.textContent = info[1];
              div.style.fontSize = info[2];
            }
          }
          document.body.appendChild(div);
        }
        for (const key in bords) {
          let div = document.createElement("div");
          div.id = key;
          div.className = "search-bar";
          //   div.className = "component text";
          //   div.style.border = "1px solid";
          document.body.appendChild(div);
          // console.log(key);
        }
        for (let i = 0; i < componentNames.size(); i++) {
          const name = componentNames.get(i);
          const div2 = document.getElementById(name);
          if (!div2) {
            let div = document.createElement("div");
            div.id = name;
            // div.textContent = name;
            div.className = "component text";
            if (name === "main_body_holder") {
              div.classList.add("main-body-holder");
            }
            document.body.appendChild(div);
            elementCache.push(div);
          } else {
            elementCache.push(div2);
          }
        }

        updateComponents(
          window.innerWidth,
          window.innerHeight,
          radiusRange.value
        );
        // 轮播图相关
        showSlide(currentIdx);
        startAutoSlide();
        checkVisibility();
      }

      function updateComponents(screenWidth, screenHight, radius) {
        const components = moduleInstance.getComponents(
          screenWidth,
          screenHight,
          radius
        );

        for (let i = 0; i < components.size(); i++) {
          const component = components.get(i);
          const div = elementCache[i]; // 从缓存数组获取组件元素
          div.style.left = component.x + "px";
          div.style.top = component.y + "px";
          div.style.width = component.w + "px";
          div.style.height = component.h + "px";
          div.style.visibility = component.v ? "visible" : "hidden";
        }
      }

      function showSlide(idx) {
        if (idx >= totalSlides) {
          currentIdx = 0;
        } else if (idx < 0) {
          currentIdx = totalSlides - 1;
        } else {
          currentIdx = idx;
        }

        const offset = -idx * 100;
        const carouselInner = document.querySelector(".carousel-inner");
        carouselInner.style.transition = "transform 0.5s ease-in-out";
        carouselInner.style.transform = `translateX(${offset}%)`;
        prevTranslate = currentTranslate = offset; // 更新当前的转换位置
      }

      function nextSlide() {
        clearInterval(autoSlideInterval);
        currentIdx = (currentIdx + 1) % totalSlides;
        showSlide(currentIdx);
        startAutoSlide();
      }

      function prevSlide() {
        clearInterval(autoSlideInterval);
        currentIdx = (currentIdx - 1 + totalSlides) % totalSlides;
        showSlide(currentIdx);
        startAutoSlide();
      }

      function startAutoSlide() {
        autoSlideInterval = setInterval(() => {
          currentIdx = (currentIdx + 1) % totalSlides;
          showSlide(currentIdx);
        }, 3000);
      }

      function getPositionX(event) {
        return event.type.includes("mouse")
          ? event.pageX
          : event.touches[0].clientX;
      }

      // 滚轮整页翻屏效果
      function enableScrollByDiameter() {
        window.addEventListener("wheel", handleScroll, { passive: false });
      }

      function disableScrollByDiameter() {
        window.removeEventListener("wheel", handleScroll);
      }

      function handleScroll(event) {
        event.preventDefault();

        if (debounceTimeout) {
          clearTimeout(debounceTimeout);
        }

        debounceTimeout = setTimeout(() => {
          const distance = window.innerWidth;

          const scrollAmount = event.deltaY > 0 ? distance : -distance;
          // 获取当前滚动位置
          const currentScroll = window.scrollY;

          // 计算目标滚动位置
          const targetScroll = currentScroll + scrollAmount;

          // 获取页面的最大滚动高度
          const maxScroll =
            document.documentElement.scrollHeight - window.innerHeight;

          // 判断是否可以滚动到目标位置
          if (targetScroll <= maxScroll) {
            window.scrollBy({
              top: scrollAmount, // 垂直方向滚动
              left: 0,
              behavior: "smooth",
            });
          }
        }, 300);
      }

      // 获取初始屏幕宽度并初始化组件
      initializeComponents(window.innerWidth);

      // 添加事件监听器，在屏幕宽度变化时实时更新组件
      window.addEventListener("resize", () => {
        updateComponents(
          window.innerWidth,
          window.innerHeight,
          radiusRange.value
        );
        checkVisibility();
      });
      radiusRange.addEventListener("input", function () {
        updateMask(radiusRange.value);
        updateComponents(
          window.innerWidth,
          window.innerHeight,
          radiusRange.value
        );
      });
    </script>
  </body>
</html>
