<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Emscripten Components</title>
    <script src="ind_cpp.js"></script>
    <script src="components.js"></script> <!-- 加载组件定义 -->
    <style>
        .component {
            position: absolute;
            border: 1px solid black;
        }

        .text {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        img {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <script>
        let moduleInstance = null;
        const elementCache = [];  // 使用数组来缓存组件元素

        function initializeComponents(screenWidth) {
            if (!moduleInstance) {
                createModule().then(Module => {
                    moduleInstance = Module;
                    const componentNames = moduleInstance.getInitialComponents();
                    renderComponents(componentNames);
                });
            } else {
                const componentNames = moduleInstance.getInitialComponents();
                renderComponents(componentNames);
            }
        }

        function renderComponents(componentNames) {
            // 清空现有组件
            elementCache.length = 0; // 清空缓存数组
            for (let i = 0; i < componentNames.size(); i++) {
                const name = componentNames.get(i);
                let div = document.createElement('div');
                div.id = name;
                div.className = 'component';

                const componentDefinition = componentDefinitions[name];
                if (componentDefinition) {
                    if (componentDefinition.type === 'text') {
                        div.className += ' text';
                        div.textContent = componentDefinition.content;
                    } else if (componentDefinition.type === 'image') {
                        const img = new Image();
                        img.src = componentDefinition.content;
                        div.appendChild(img);
                    }
                }
                document.body.appendChild(div);
                elementCache.push(div);  // 将组件元素添加到缓存数组
            }
            updateComponents(window.innerWidth);
        }

        function updateComponents(screenWidth) {
            const components = moduleInstance.getComponents(screenWidth);

            for (let i = 0; i < components.size(); i++) {
                const component = components.get(i);
                const div = elementCache[i];  // 从缓存数组获取组件元素
                div.style.left = component.x + 'px';
                div.style.top = component.y + 'px';
                div.style.width = component.w + 'px';
                div.style.height = component.h + 'px';
                div.style.visibility = component.v ? 'visible' : 'hidden';
            }
        }

        // 获取初始屏幕宽度并初始化组件
        initializeComponents(window.innerWidth);

        // 添加事件监听器，在屏幕宽度变化时实时更新组件
        window.addEventListener('resize', () => {
            updateComponents(window.innerWidth);
        });
    </script>
</body>

</html>